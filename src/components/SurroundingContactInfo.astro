---
import { useTranslations } from "@/lib/i18n";
import Button from "./ui/button/button.astro";
import PlatformIcon from "./ui/icons/PlatformIcon.astro";
import { Phone } from "@lucide/astro";

const { lang, surrounding } = Astro.props as {
  lang: string;
  surrounding: {
    socialMedia?: Array<{ platform: string; link: string }>;
    phoneNumber?: string;
    website?: string;
    bookLink?: string;
  };
};

const t = useTranslations(lang as any);
---

<div class="grid gap-8">
  {
    surrounding?.socialMedia && surrounding?.socialMedia?.length > 0 && (
      <div>
        <h3 class="text-2xl">{t("surroundings.detail.socialNetworks")}</h3>
        <ul>
          <li>
            {surrounding.socialMedia.map((social) => (
              <Button
                class="-ml-4"
                variant="link"
                href={social.link}
                target="_blank"
                rel="noopener noreferrer"
              >
                <PlatformIcon platform={social.platform} class="size-4" />
                {social.platform}
              </Button>
            ))}
          </li>
        </ul>
      </div>
    )
  }
  <div class="flex flex-wrap gap-6">
    {
      surrounding && "bookLink" in surrounding && surrounding.bookLink ? (
        <Button
          external
          href={surrounding.bookLink}
          data-surrounding-contact="booking"
        >
          {t("surroundings.detail.book")}
        </Button>
      ) : null
    }
    {
      surrounding?.phoneNumber ? (
        <Button
          variant="outline"
          href={`tel:${surrounding.phoneNumber}`}
          data-surrounding-contact="phone"
        >
          <Phone />
          {t("surroundings.detail.call")}
        </Button>
      ) : null
    }
    {
      surrounding?.website ? (
        <Button
          variant="link"
          class="-mx-6 gap-3!"
          external
          href={surrounding.website}
          data-surrounding-contact="website"
        >
          {t("surroundings.detail.visitWebsite")}
        </Button>
      ) : null
    }
  </div>
</div>

<script>
  // Use event delegation for contact tracking with cleanup on navigation
  const contactTrackingAbortController = new AbortController();

  document.body.addEventListener(
    "click",
    (e) => {
      const contactBtn = (e.target as Element).closest(
        "[data-surrounding-contact]",
      );
      if (!contactBtn) return;

      const title = document.querySelector("h1");
      const contactType = contactBtn.getAttribute("data-surrounding-contact");

      if (window.plausible && title && contactType) {
        window.plausible("surrounding_contact_clicked", {
          props: {
            name: title.textContent || "unknown",
            type: contactType,
          },
        });
      }
    },
    { signal: contactTrackingAbortController.signal },
  );

  // Cleanup on navigation
  document.addEventListener(
    "astro:before-swap",
    () => {
      contactTrackingAbortController.abort();
    },
    { once: true },
  );
</script>

---
import Button from "@/components/ui/button/button.astro";
import { getLangFromUrl, useTranslations } from "@/lib/i18n";

interface Props {
  src: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { src } = Astro.props as Props;

const serviceName = (() => {
  try {
    const parsed = new URL(src, "https://placeholder.local");
    return parsed.hostname === "placeholder.local"
      ? t("iframeConsent.serviceNameFallback")
      : parsed.hostname;
  } catch (fallbackError) {
    return t("iframeConsent.serviceNameFallback");
  }
})();
---

<div class="aspect-video w-full rounded-md border-0">
  <div
    class="iframe-consent bg-muted flex h-full w-full flex-col items-center justify-center gap-4 rounded-md border p-6 text-center"
    data-iframe-src={src}
  >
    <div>
      <h3 class="mb-2 text-lg font-semibold">{t("iframeConsent.title")}</h3>
      <p>
        {t("iframeConsent.text").replace("{serviceName}", serviceName)}
      </p>
    </div>
    <Button data-consent-button>{t("iframeConsent.button")}</Button>
  </div>
</div>

<script>
  // Handle iframe consent
  const CONSENT_SELECTOR = ".iframe-consent";
  const BUTTON_SELECTOR = "[data-consent-button]";

  document.querySelectorAll(CONSENT_SELECTOR).forEach((element) => {
    const src = element.getAttribute("data-iframe-src");
    const hostPath = getHostPath(src);
    const consentKey = `iframe-consent-${hostPath ?? src ?? "unknown"}`;
    const button = element.querySelector(
      BUTTON_SELECTOR,
    ) as HTMLButtonElement | null;

    // Check if consent was already given
    if (localStorage.getItem(consentKey)) {
      loadIframe(element);
      return;
    }

    button?.addEventListener("click", () => {
      localStorage.setItem(consentKey, "true");
      loadIframe(element);
    });
  });

  function getHostPath(url?: string | null) {
    if (!url) return null;
    try {
      const parsed = new URL(url, window.location.href);
      return `${parsed.hostname}${parsed.pathname}`;
    } catch (error) {
      console.error("Invalid iframe URL", error);
      return null;
    }
  }

  function loadIframe(element: Element) {
    const src = element.getAttribute("data-iframe-src");
    if (!src) return;

    const iframeContainer = document.createElement("div");
    iframeContainer.innerHTML = `
      <iframe
        src="${src}"
        class="w-full h-full aspect-video rounded-md border-0 dark:hue-rotate-180 dark:invert-[0.8] dark:contrast-125"
        allowfullscreen=""
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
    `;

    element.parentElement?.replaceChild(
      iframeContainer.firstElementChild!,
      element,
    );
  }
</script>

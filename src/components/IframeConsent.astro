---
import Button from "@/components/ui/button/button.astro";
import { getLangFromUrl, useTranslations, getLocalizedUrl } from "@/lib/i18n";
import { cn } from "@/lib/utils";

interface Props {
  src: string;
  serviceName: string;
  class?: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { src, serviceName, class: className } = Astro.props as Props;

const privacyPolicyUrl = getLocalizedUrl("privacyPolicy", lang);

const hostname = (() => {
  try {
    const parsed = new URL(src);
    return parsed.hostname;
  } catch {
    return t("iframeConsent.serviceNameFallback");
  }
})();
---

<div
  class={cn("w-full rounded-md border-0", className)}
  data-iframe-class={className ?? ""}
>
  <div
    class="iframe-consent bg-muted flex h-full w-full flex-col items-center justify-center gap-4 rounded-md border p-6 text-center"
    data-iframe-src={src}
  >
    <div>
      <p class="h3 mb-2 text-lg font-semibold">
        {t("iframeConsent.mapLabel")}
        {serviceName}
      </p>
      <p class="mb-4">
        {t("iframeConsent.text").replace("{hostname}", hostname)}
      </p>
      <p>
        {t("iframeConsent.privacyPrefix")}
        <Button variant="link" class="-mx-6 -my-4" href={privacyPolicyUrl}>
          {t("iframeConsent.privacyLink")}
        </Button>
      </p>
    </div>
    <Button data-consent-button>{t("iframeConsent.button")}</Button>
  </div>
</div>

<script>
  // Handle iframe consent
  const CONSENT_SELECTOR = ".iframe-consent";
  const BUTTON_SELECTOR = "[data-consent-button]";

  function initIframeConsent() {
    document.querySelectorAll(CONSENT_SELECTOR).forEach((element) => {
      const src = element.getAttribute("data-iframe-src");
      const hostPath = getHostPath(src);
      const consentKey = `iframe-consent-${hostPath ?? src ?? "unknown"}`;
      const button = element.querySelector(
        BUTTON_SELECTOR,
      ) as HTMLButtonElement | null;

      // Check if consent was already given
      if (localStorage.getItem(consentKey)) {
        loadIframe(element);
        return;
      }

      button?.addEventListener("click", () => {
        localStorage.setItem(consentKey, "true");
        loadIframe(element);
      });
    });
  }

  initIframeConsent();
  document.addEventListener("astro:page-load", initIframeConsent);

  function getHostPath(url?: string | null) {
    if (!url) return null;
    try {
      const parsed = new URL(url, window.location.href);
      return `${parsed.hostname}${parsed.pathname}`;
    } catch (error) {
      console.error("Invalid iframe URL", error);
      return null;
    }
  }

  function loadIframe(element: Element) {
    const src = element.getAttribute("data-iframe-src");
    if (!src) return;

    const wrapper = element.parentElement;
    const wrapperClass = wrapper?.getAttribute("data-iframe-class") ?? "";

    const iframeContainer = document.createElement("div");
    iframeContainer.innerHTML = `
      <iframe
        src="${src}"
        class="w-full h-full rounded-md border-0 dark:hue-rotate-180 dark:invert-[0.8] dark:contrast-125 ${wrapperClass}"
        allowfullscreen=""
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
    `;

    wrapper?.replaceChild(iframeContainer.firstElementChild!, element);
  }
</script>

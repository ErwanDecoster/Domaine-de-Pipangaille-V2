---
import Layout from "@/layouts/Layout.astro";
import MediaContent from "@/components/MediaContent.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import { reviews } from "@/constants/reviews";
import { roomsContent } from "@/constants/rooms";
import { SCHEMA_CONFIG } from "@/constants/schemaConfig";
import Button from "../ui/button/button.astro";
import Card from "../Card.astro";
import breakfastWindow from "@/images/breakfast-window.jpg";
import type { ImageMetadata } from "astro";
import {
  generateLocalizedBreadcrumbList,
  generateLocalizedRoomSchema,
} from "@/lib/schemaHelpers";

const { lang } = Astro.props as { lang: keyof typeof reviews };
const t = useTranslations(lang);
const roomButtonText = t("accommodations.rooms.button");

const toTranslationKey = (key: string) => key as Parameters<typeof t>[0];
const getImageSrc = (image: ImageMetadata | string) =>
  typeof image === "string" ? image : image.src;

const rooms = roomsContent.map((room) => ({
  key: room.key,
  title: t(`accommodations.rooms.${room.key}.title`),
  image: room.image,
  description: t(`accommodations.rooms.${room.key}.description`),
  tags: room.tags.map((tag) => ({
    icon: tag.icon,
    text: t(toTranslationKey(tag.labelKey)),
  })),
  buttonLink: getLocalizedUrl("accommodation", lang, room.key),
}));

const accommodationsHeroParagraphs = t("accommodations.hero.text")
  .split(/\n\s*\n/)
  .filter(Boolean);

const breadcrumbSchema = generateLocalizedBreadcrumbList(
  lang as "fr" | "en" | "de" | "es" | "it" | "nl",
  [
    { name: "home", path: getLocalizedUrl("home", lang) },
    { name: "accommodations", path: getLocalizedUrl("accommodations", lang) },
  ],
);

const siteUrl = SCHEMA_CONFIG.site.url;
const convertToAbsoluteUrl = (imageSrc: string): string => {
  if (imageSrc.includes("/_astro/")) {
    return `${siteUrl}${imageSrc}`;
  }
  return imageSrc.startsWith("http") ? imageSrc : `${siteUrl}${imageSrc}`;
};

const roomSchemas = roomsContent
  .map((room) => {
    const roomImageUrls = [
      convertToAbsoluteUrl(getImageSrc(room.image)),
      ...room.gallery.map((g) => convertToAbsoluteUrl(getImageSrc(g.src))),
    ];
    return generateLocalizedRoomSchema(
      room.key,
      roomImageUrls,
      lang as "fr" | "en" | "de" | "es" | "it" | "nl",
    );
  })
  .filter(Boolean) as unknown as Record<string, unknown>[];
---

<Layout
  title={t("seo.pages.accommodations.title")}
  description={t("seo.pages.accommodations.description")}
  ogImage="/og/accommodations/marocaine.jpg"
  additionalSchemas={[breadcrumbSchema, ...roomSchemas]}
>
  <div
    data-scroll-animated
    class="bg-background sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
  >
  </div>
  <div class="px-4 pt-12 sm:px-6 md:px-10 md:pt-24 lg:px-20">
    <h1>{t("accommodations.hero.title")}</h1>
    <div class="mt-12 flex max-w-4xl flex-col gap-4 md:w-4/5">
      {accommodationsHeroParagraphs.map((p) => <p>{p}</p>)}
    </div>
  </div>

  <section
    class="mt-12 grid gap-8 px-4 sm:px-6 md:grid-cols-2 md:gap-10 md:px-10 lg:px-20"
  >
    {
      rooms.map((room, index) => (
        <Card
          title={room.title}
          titleLevel="h2"
          image={room.image}
          imageAlt={room.title}
          description={room.description}
          tags={room.tags}
          buttonText={roomButtonText}
          buttonLink={room.buttonLink}
          isLCP={index === 0}
          sizes="(min-width: 1280px) 620px, (min-width: 768px) 48vw, 100vw"
        />
      ))
    }
  </section>

  <MediaContent
    title={t("accommodations.breakfast.title")}
    text={t("accommodations.breakfast.text")}
    image={breakfastWindow}
    ratio="4-5"
  />

  <section class="my-24 px-4 sm:px-6 md:my-48 md:px-10 lg:px-20">
    <div class="bg-muted mx-auto max-w-5xl rounded-3xl px-6 py-24">
      <div class="mx-auto w-fit max-w-2xl space-y-10 text-center">
        <h2 class="h3">{t("accommodations.cta.title")}</h2>
        <p>{t("accommodations.cta.text")}</p>
        <Button href={getLocalizedUrl("contact", lang)}>
          {t("accommodations.cta.button")}
        </Button>
      </div>
    </div>
  </section>
</Layout>

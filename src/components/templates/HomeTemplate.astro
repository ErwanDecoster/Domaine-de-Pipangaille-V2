---
import { Button } from "@/components/ui/button";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import MediaContent from "@/components/MediaContent.astro";
import ReviewList from "@/components/ReviewList.astro";
import Card from "@/components/Card.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import { reviews } from "@/constants/reviews";
import { surroundings } from "@/constants/surroundings";
import { generateLocalizedBreadcrumbList } from "@/lib/schemaHelpers";

import courtyardTerraceLawn from "@/images/courtyard-terrace-lawn.jpeg";
import moroccanRoomFrenchDoor from "@/images/moroccan-room-french-door.jpeg";
import gardenCheeseAndCharcuterieBoard from "@/images/garden-cheese-and-charcuterie-board.jpg";

const { lang } = Astro.props as { lang: keyof typeof reviews };
const t = useTranslations(lang);

type TranslationKey = Parameters<typeof t>[0];
const toKey = (key: string) => key as TranslationKey;

const langPrefix = lang === "fr" ? "/" : `/${lang}/`;
const breadcrumbSchema = generateLocalizedBreadcrumbList(
  lang as "fr" | "en" | "de" | "es" | "it" | "nl",
  langPrefix,
  [{ name: "home", path: "" }],
);

const formatCard = (item: (typeof surroundings.toVisit)[number]) => {
  const categories = item.category ?? [];
  const firstImage = item.gallery?.[0];

  return {
    title: item.title,
    image: firstImage?.src,
    imageAlt: t(toKey(firstImage?.altKey ?? "")),
    description: item.shortDesc ? t(toKey(item.shortDesc)) : undefined,
    tags: categories.map((cat) => ({
      text: t(toKey(`surroundings.category.${cat}`)),
    })),
    buttonText: t("surroundings.card.cta"),
    buttonLink: getLocalizedUrl("surrounding", lang, item.slug),
  };
};

const featuredSlugs = [
  "safari_peaugres",
  "palais_ideal_du_facteur_cheval",
  "viarhona",
  "musee_de_l_alambic",
  "viafluvia",
];

const featuredSurroundings = featuredSlugs
  .map((slug) => surroundings.toVisit.find((s) => s.slug === slug))
  .filter(Boolean) as (typeof surroundings.toVisit)[number][];
---

<Layout
  title={t("seo.pages.home.title")}
  description={t("seo.pages.home.description")}
  additionalSchemas={[breadcrumbSchema]}
>
  <div
    data-scroll-animated
    class="bg-muted sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
  >
  </div>
  <Header
    title={t("home.header.title")}
    text={t("home.header.text")}
    image={courtyardTerraceLawn}
    imageAlt={t("home.header.imageAlt")}
    buttonText={t("home.header.button")}
    buttonLink={getLocalizedUrl("place", lang)}
  />
  <div
    data-scroll-animated
    class="bg-background sticky top-0 z-10 -mb-20 ml-[calc(50%-50vw)] h-28 w-screen"
  >
  </div>
  <MediaContent
    direction="left"
    title={t("home.rooms.title")}
    text={t("home.rooms.text")}
    image={moroccanRoomFrenchDoor}
    imageAlt={t("home.rooms.imageAlt")}
    buttonText={t("home.rooms.button")}
    buttonLink={getLocalizedUrl("accommodations", lang)}
  />
  <MediaContent
    title={t("home.counter.title")}
    text={t("home.counter.text")}
    image={gardenCheeseAndCharcuterieBoard}
    imageAlt={t("home.counter.imageAlt")}
    buttonText={t("home.counter.button")}
    buttonLink={getLocalizedUrl("counter", lang)}
  />
  <ReviewList title={t("home.reviews.title")} reviews={reviews[lang]} />
  <section
    class="mt-24 grid gap-8 px-4 sm:px-6 md:mt-48 md:grid-cols-6 md:gap-10 md:px-10 lg:px-20"
  >
    <h2 class="mb-4 md:col-span-6">{t("home.surroundings.title")}</h2>
    {
      featuredSurroundings.map((surrounding, index) => {
        const card = formatCard(surrounding);
        const sizes =
          index < 2
            ? "(min-width: 768px) 50vw, 100vw"
            : "(min-width: 768px) 33vw, 100vw";
        return (
          <Card
            {...card}
            class={index < 2 ? "md:col-span-3" : "md:col-span-2"}
            sizes={sizes}
          />
        );
      })
    }
    <Button
      href={getLocalizedUrl("surroundings", lang)}
      class="mx-auto mt-6 md:col-span-6"
    >
      {t("home.surroundings.button")}
    </Button>
  </section>
  <section class="my-24 px-4 sm:px-6 md:my-48 md:px-10 lg:px-20">
    <div class="bg-muted mx-auto max-w-5xl rounded-3xl px-6 py-24">
      <div class="mx-auto w-fit space-y-10">
        <h3 class="text-center md:text-left">{t("home.booking.title")}</h3>
        <div class="flex flex-col items-center justify-between md:flex-row">
          <Button href={getLocalizedUrl("booking", lang)}>
            {t("home.booking.button")}
          </Button>
          <Button
            href={getLocalizedUrl("accommodations", lang)}
            variant="secondary"
          >
            {t("home.booking.secondaryButton")}
          </Button>
        </div>
      </div>
    </div>
  </section>
</Layout>

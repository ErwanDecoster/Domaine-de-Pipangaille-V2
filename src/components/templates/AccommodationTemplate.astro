---
import Layout from "@/layouts/Layout.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import { reviews } from "@/constants/reviews";
import { roomsContent } from "@/constants/rooms";
import Card from "../Card.astro";
import { Image } from "astro:assets";
import NotFoundTemplate from "./NotFoundTemplate.astro";
import FullscreenGallery from "@/components/FullscreenGallery.astro";
import {
  generateLocalizedRoomSchema,
  generateImageGallerySchema,
  generateLocalizedBreadcrumbList,
} from "@/lib/schemaHelpers";
import type { ImageMetadata } from "astro";

const { lang, roomName } = Astro.props as {
  lang: keyof typeof reviews;
  roomName: string;
};
const t = useTranslations(lang);
const toTranslationKey = (key: string) => key as Parameters<typeof t>[0];

const baseRoom = roomsContent.find((room) => room.key === roomName);
const isNotFound = !baseRoom;

const roomButtonText = t("accommodations.rooms.button");
const equipmentsTitle = t("accommodations.detail.equipments.title");
const equipmentsNote = baseRoom?.equipmentsNoteKey
  ? t(toTranslationKey(baseRoom.equipmentsNoteKey))
  : undefined;
const otherRoomsTitle = t("accommodations.detail.otherRooms.title");

const selectedRoomOgImage = baseRoom
  ? `/og/accommodations/${baseRoom.key}.jpg`
  : "/og/og-image.jpg";

const selectedRoomTitle = baseRoom
  ? t(`accommodations.rooms.${baseRoom.key}.title`)
  : "";
const selectedRoomLongDescription = baseRoom
  ? t(`accommodations.rooms.${baseRoom.key}.longDescription`)
  : "";
const getImageSrc = (image: ImageMetadata | string) =>
  typeof image === "string" ? image : image.src;
const galleryImages: { src: ImageMetadata; alt: string }[] = baseRoom
  ? baseRoom.gallery.map((image) => ({
      src: image.src,
      alt: t(toTranslationKey(image.altKey)),
    }))
  : [];
const gallerySchemaImages = galleryImages.map((image) => ({
  ...image,
  src: getImageSrc(image.src),
}));

const selectedRoomEquipments = baseRoom
  ? baseRoom.equipments.map((equipment) => ({
      icon: equipment.icon,
      text: t(toTranslationKey(equipment.labelKey)),
    }))
  : [];
const otherRooms = roomsContent
  .filter((room) => room.key !== roomName)
  .map((room) => ({
    key: room.key,
    title: t(`accommodations.rooms.${room.key}.title`),
    image: room.image,
    imageAlt: t(`accommodations.rooms.${room.key}.title`),
    description: t(`accommodations.rooms.${room.key}.description`),
    tags: room.tags.map((tag) => ({
      icon: tag.icon,
      text: t(toTranslationKey(tag.labelKey)),
    })),
    buttonLink: getLocalizedUrl("accommodation", lang, room.key),
  }));

let additionalSchemas: Record<string, unknown>[] = [];
if (baseRoom) {
  const roomImageUrls = [
    getImageSrc(baseRoom.image),
    ...baseRoom.gallery.map((g) => getImageSrc(g.src)),
  ];
  const roomSchema = generateLocalizedRoomSchema(
    baseRoom.key,
    roomImageUrls as unknown as string[],
    lang as "fr" | "en" | "de" | "es" | "it" | "nl",
  );

  const gallerySchema = generateImageGallerySchema(
    gallerySchemaImages.map((img, idx) => ({
      url: img.src,
      name: `${selectedRoomTitle} - Image ${idx + 1}`,
      description: img.alt,
    })),
  );

  const breadcrumbSchema = generateLocalizedBreadcrumbList(
    lang as "fr" | "en" | "de" | "es" | "it" | "nl",
    [
      { name: "home", path: getLocalizedUrl("home", lang) },
      { name: "accommodations", path: getLocalizedUrl("accommodations", lang) },
      {
        name: "room",
        path: getLocalizedUrl("accommodation", lang, baseRoom.key),
      },
    ],
  );

  additionalSchemas = [roomSchema, gallerySchema, breadcrumbSchema].filter(
    Boolean,
  ) as Record<string, unknown>[];
}
---

{
  isNotFound ? (
    <NotFoundTemplate lang={lang} />
  ) : (
    <Layout
      title={
        baseRoom
          ? t(
              `seo.pages.accommodations.${baseRoom.key}.title` as Parameters<
                typeof t
              >[0],
            )
          : t("seo.pages.accommodations.title")
      }
      description={
        baseRoom
          ? t(
              `seo.pages.accommodations.${baseRoom.key}.description` as Parameters<
                typeof t
              >[0],
            )
          : t("seo.pages.accommodations.description")
      }
      ogImage={selectedRoomOgImage}
      additionalSchemas={additionalSchemas}
    >
      <div
        data-scroll-animated
        class="bg-background sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
      />
      <div class="px-4 pt-12 sm:px-6 md:px-10 md:pt-24 lg:px-20">
        <h1>{selectedRoomTitle}</h1>
        <p class="mt-12 max-w-4xl md:w-4/5">{selectedRoomLongDescription}</p>
      </div>

      <div class="mt-12 grid grid-cols-1 gap-4 px-4 sm:grid-cols-2 sm:gap-6 sm:px-6 md:px-10 lg:grid-cols-4 lg:px-20">
        <Image
          class="aspect-video cursor-zoom-in sm:col-span-2 sm:row-span-2 sm:aspect-auto sm:h-full"
          quality="40"
          width={740}
          height={555}
          sizes="(min-width: 1024px) 50vw, (min-width: 640px) 50vw, 100vw"
          src={galleryImages[0].src}
          alt={galleryImages[0].alt}
          data-gallery="room-gallery"
          fetchpriority="high"
          loading="eager"
          data-index="0"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="40"
          width={358}
          height={268}
          sizes="(min-width: 1024px) 25vw, (min-width: 640px) 50vw, 100vw"
          src={galleryImages[1].src}
          alt={galleryImages[1].alt}
          data-gallery="room-gallery"
          data-index="1"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="40"
          width={358}
          height={268}
          sizes="(min-width: 1024px) 25vw, (min-width: 640px) 50vw, 100vw"
          src={galleryImages[2].src}
          alt={galleryImages[2].alt}
          data-gallery="room-gallery"
          data-index="2"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="40"
          width={358}
          height={268}
          sizes="(min-width: 1024px) 25vw, (min-width: 640px) 50vw, 100vw"
          src={galleryImages[3].src}
          alt={galleryImages[3].alt}
          data-gallery="room-gallery"
          data-index="3"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="40"
          width={358}
          height={268}
          sizes="(min-width: 1024px) 25vw, (min-width: 640px) 50vw, 100vw"
          src={galleryImages[4].src}
          alt={galleryImages[4].alt}
          data-gallery="room-gallery"
          data-index="4"
        />
      </div>

      <section class="px-4 pt-48 sm:px-6 md:px-10 lg:px-20">
        <h2>{equipmentsTitle}</h2>
        <ul class="mt-12 grid w-full gap-1 sm:grid-cols-2 md:grid-cols-3 lg:w-4/5">
          {selectedRoomEquipments.map((equip) => (
            <li class="flex items-center gap-2">
              {equip.icon && <equip.icon size={16} />}
              <span>{equip.text}</span>
            </li>
          ))}
        </ul>
        {equipmentsNote && (
          <p class="bg-muted mt-8 rounded-lg p-4">{equipmentsNote}</p>
        )}
      </section>

      <section class="my-24 grid gap-8 px-4 sm:px-6 md:my-48 md:grid-cols-3 md:gap-10 md:px-10 lg:px-20">
        <h2 class="md:col-span-3">{otherRoomsTitle}</h2>
        {otherRooms.map((room) => (
          <Card
            title={room.title}
            image={room.image}
            imageAlt={room.imageAlt}
            description={room.description}
            tags={room.tags}
            buttonText={roomButtonText}
            buttonLink={room.buttonLink}
            sizes="(min-width: 768px) 33vw, 100vw"
          />
        ))}
      </section>
      {galleryImages.length ? (
        <FullscreenGallery
          galleryId="room-gallery"
          images={galleryImages.map((img) => ({
            src: img.src,
            alt: img.alt,
          }))}
        />
      ) : null}

      <script>
        import { plausibleEvents } from "@/lib/plausibleEvents";

        function initRoomDetailsTracking() {
          // Track when page loads (room details viewed)
          const roomTitle = document.querySelector("h1");
          if (roomTitle) {
            plausibleEvents.roomDetailsOpened(roomTitle.textContent || "unknown");
          }

          // Track gallery opens
          const galleryImages = document.querySelectorAll(
            '[data-gallery="room-gallery"]',
          );
          galleryImages.forEach((img) => {
            img.addEventListener("click", () => {
              if (roomTitle) {
                plausibleEvents.galleryOpened(roomTitle.textContent || "unknown");
              }
            });
          });
        }

        initRoomDetailsTracking();
        document.addEventListener("astro:page-load", initRoomDetailsTracking);
      </script>
    </Layout>
  )
}

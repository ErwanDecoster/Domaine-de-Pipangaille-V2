---
import Layout from "@/layouts/Layout.astro";
import MediaContent from "@/components/MediaContent.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import { reviews } from "@/constants/reviews";
import { roomsContent } from "@/constants/rooms";
import Card from "../Card.astro";
import { Image } from "astro:assets";
import tableDHotes from "@/images/table-d-hotes.jpg";
import pool from "@/images/pool.jpeg";
import courtyardTerraceCorner from "@/images/courtyard-terrace-corner.jpeg";
import NotFoundTemplate from "./NotFoundTemplate.astro";
import FullscreenGallery from "@/components/FullscreenGallery.astro";

const { lang, roomName } = Astro.props as {
  lang: keyof typeof reviews;
  roomName: string;
};
const t = useTranslations(lang);
const toTranslationKey = (key: string) => key as Parameters<typeof t>[0];

const baseRoom = roomsContent.find((room) => room.key === roomName);
const isNotFound = !baseRoom;

const roomButtonText = t("accommodations.rooms.button");
const equipmentsTitle = t("accommodations.detail.equipments.title");
const equipmentsNote = baseRoom?.equipmentsNoteKey
  ? t(toTranslationKey(baseRoom.equipmentsNoteKey))
  : undefined;
const tableTitle = t("accommodations.detail.table.title");
const tableText = t("accommodations.detail.table.text");
const exploreTitle = t("accommodations.detail.explore.title");
const exploreText = t("accommodations.detail.explore.text");
const otherRoomsTitle = t("accommodations.detail.otherRooms.title");

const selectedRoomTitle = baseRoom
  ? t(`accommodations.rooms.${baseRoom.key}.title`)
  : "";
const selectedRoomLongDescription = baseRoom
  ? t(`accommodations.rooms.${baseRoom.key}.longDescription`)
  : "";
const galleryImages = baseRoom
  ? baseRoom.gallery.map((image) => ({
      src: image.src,
      alt: t(toTranslationKey(image.altKey)),
    }))
  : [];

const selectedRoomEquipments = baseRoom
  ? baseRoom.equipments.map((equipment) => ({
      icon: equipment.icon,
      text: t(toTranslationKey(equipment.labelKey)),
    }))
  : [];
const otherRooms = roomsContent
  .filter((room) => room.key !== roomName)
  .map((room) => ({
    key: room.key,
    title: t(`accommodations.rooms.${room.key}.title`),
    image: room.image,
    imageAlt: t(`accommodations.rooms.${room.key}.title`),
    description: t(`accommodations.rooms.${room.key}.description`),
    tags: room.tags.map((tag) => ({
      icon: tag.icon,
      text: t(toTranslationKey(tag.labelKey)),
    })),
    buttonLink: getLocalizedUrl("accommodation", lang, room.key),
  }));
---

{
  isNotFound ? (
    <NotFoundTemplate lang={lang} />
  ) : (
    <Layout
      title={
        baseRoom
          ? t(
              `seo.pages.accommodations.${baseRoom.key}.title` as Parameters<
                typeof t
              >[0],
            )
          : t("seo.pages.accommodations.title")
      }
      description={
        baseRoom
          ? t(
              `seo.pages.accommodations.${baseRoom.key}.description` as Parameters<
                typeof t
              >[0],
            )
          : t("seo.pages.accommodations.description")
      }
    >
      <div
        data-scroll-animated
        class="bg-background sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
      />
      <div class="px-4 pt-12 sm:px-6 md:px-10 md:pt-24 lg:px-20">
        <h1>{selectedRoomTitle}</h1>
        <p class="mt-12 max-w-4xl md:w-4/5">{selectedRoomLongDescription}</p>
      </div>

      <div class="mt-12 grid grid-cols-1 gap-4 px-4 sm:grid-cols-2 sm:gap-6 sm:px-6 md:px-10 lg:grid-cols-4 lg:px-20">
        <Image
          class="aspect-video cursor-zoom-in sm:col-span-2 sm:row-span-2 sm:aspect-auto sm:h-full"
          quality="60" 
          src={galleryImages[0].src}
          alt={galleryImages[0].alt}
          data-gallery="room-gallery"
          data-index="0"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="60" 
          src={galleryImages[1].src}
          alt={galleryImages[1].alt}
          data-gallery="room-gallery"
          data-index="1"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="60" 
          src={galleryImages[2].src}
          alt={galleryImages[2].alt}
          data-gallery="room-gallery"
          data-index="2"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="60" 
          src={galleryImages[3].src}
          alt={galleryImages[3].alt}
          data-gallery="room-gallery"
          data-index="3"
        />
        <Image
          class="aspect-video cursor-zoom-in sm:aspect-4/3"
          quality="60" 
          src={galleryImages[4].src}
          alt={galleryImages[4].alt}
          data-gallery="room-gallery"
          data-index="4"
        />
      </div>

      <section class="px-4 pt-48 sm:px-6 md:px-10 lg:px-20">
        <h2>{equipmentsTitle}</h2>
        <ul class="mt-12 grid w-full gap-1 sm:grid-cols-2 md:grid-cols-3 lg:w-4/5">
          {selectedRoomEquipments.map((equip) => (
            <li class="flex items-center gap-2">
              {equip.icon && <equip.icon size={16} />}
              <span>{equip.text}</span>
            </li>
          ))}
        </ul>
        {equipmentsNote && (
          <p class="bg-muted mt-8 rounded-lg p-4">{equipmentsNote}</p>
        )}
      </section>

      <MediaContent
        title={tableTitle}
        text={tableText}
        image={tableDHotes}
        ratio="4-5"
      />

      <section class="px-4 pt-48 sm:px-6 md:px-10 lg:px-20">
        <h2>{exploreTitle}</h2>
        <p class="mt-8">{exploreText}</p>
        <div class="mt-12 grid gap-6 md:grid-cols-2">
          <Image class="aspect-video" quality="60"  src={pool} alt="TODO" />
          <Image
            class="aspect-video"
            quality="60" 
            src={courtyardTerraceCorner}
            alt="TODO"
          />
        </div>
      </section>

      <section class="mt-24 grid gap-8 px-4 sm:px-6 md:mt-48 md:grid-cols-3 md:gap-10 md:px-10 lg:px-20">
        <h2 class="md:col-span-3">{otherRoomsTitle}</h2>
        {otherRooms.map((room) => (
          <Card
            title={room.title}
            image={room.image}
            imageAlt={room.imageAlt}
            description={room.description}
            tags={room.tags}
            buttonText={roomButtonText}
            buttonLink={room.buttonLink}
          />
        ))}
      </section>
      {galleryImages.length ? (
        <FullscreenGallery
          galleryId="room-gallery"
          images={galleryImages.map((img) => ({
            src: img.src,
            alt: img.alt,
          }))}
        />
      ) : null}
    </Layout>
  )
}

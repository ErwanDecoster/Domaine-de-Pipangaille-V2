---
import Layout from "@/layouts/Layout.astro";
import MediaContent from "@/components/MediaContent.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import Button from "../ui/button/button.astro";
import type { reviews } from "@/constants/reviews";
import Field from "@/components/ui/field/field.astro";
import FieldLabel from "@/components/ui/field/field-label.astro";
import Input from "@/components/ui/input/input.astro";
import Textarea from "@/components/ui/textarea/textarea.astro";
import { actions } from "astro:actions";
import IframeConsent from "../IframeConsent.astro";
import { FieldSet } from "../ui/field/index.astro";
import courtyardConcert from "@/images/courtyard-concert.jpeg";
import MapProviderDialog from "../MapProviderDialog.astro";

const { lang } = Astro.props as { lang: keyof typeof reviews };
const t = useTranslations(lang);

const placeAddress = "1 Quartier Les Marettes, 26140, Andancette";

const result = Astro.getActionResult(actions.contact.send);

const getFieldErrors = (error: unknown): Record<string, string[]> | null => {
  if (error && typeof error === "object" && "fields" in error) {
    const fields = (error as { fields?: Record<string, string[]> }).fields;
    return fields && typeof fields === "object" ? fields : null;
  }
  return null;
};
---

<Layout
  title={t("seo.pages.contact.title")}
  description={t("seo.pages.contact.description")}
>
  <div
    data-scroll-animated
    class="bg-background sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
  >
  </div>
  <div class="px-4 pt-12 sm:px-6 md:px-10 md:pt-24 lg:px-20">
    <h1>{t("contact.title")}</h1>
    <p class="bg-muted mt-12 rounded-lg p-4">
      {t("contact.reservation.textBefore")}
      <Button
        class="-mx-6 inline"
        variant="link"
        href={getLocalizedUrl("booking", lang)}
      >
        {t("nav.book")}
      </Button>
      {t("contact.reservation.textAfter")}
    </p>
  </div>

  <section
    class="mt-12 flex flex-col gap-8 px-4 sm:px-6 md:gap-10 md:px-10 lg:flex-row lg:px-20"
  >
    <form
      method="POST"
      action={actions.contact.send}
      class="bg-muted grow rounded-md px-6 py-8 md:px-12 md:py-16"
      id="contact-form"
    >
      {
        result?.error && (
          <div class="col-span-2 mb-4 rounded-lg bg-red-100 p-4 text-red-900 dark:bg-red-900/20 dark:text-red-200">
            <p class="font-semibold">{t("contact.error.title")}</p>
            {result.error.code === "BAD_REQUEST" &&
            getFieldErrors(result.error) ? (
              <ul class="mt-2 list-inside list-disc">
                {Object.entries(getFieldErrors(result.error) ?? {}).flatMap(
                  ([, errors]) =>
                    (errors ?? []).map((error) => <li>{error}</li>),
                )}
              </ul>
            ) : (
              <p class="mt-2">{result.error.message}</p>
            )}
          </div>
        )
      }
      {
        result?.data && (
          <div class="col-span-2 mb-4 rounded-lg bg-green-100 p-4 text-green-900 dark:bg-green-900/20 dark:text-green-200">
            <p class="font-semibold">{t("contact.success.title")}</p>
            <p class="mt-2">{t("contact.success.text")}</p>
          </div>
        )
      }
      <FieldSet class="grid gap-6 md:grid-cols-2">
        <Field>
          <FieldLabel for="name">{t("contact.form.fullName")}</FieldLabel>
          <Input
            type="text"
            id="name"
            name="name"
            autocomplete="name"
            placeholder={t("contact.form.fullNamePlaceholder")}
            required
          />
        </Field>
        <Field>
          <FieldLabel for="email">{t("contact.form.email")}</FieldLabel>
          <Input
            type="email"
            id="email"
            name="email"
            autocomplete="email"
            placeholder={t("contact.form.emailPlaceholder")}
            required
          />
        </Field>
        <Field>
          <FieldLabel for="object">{t("contact.form.subject")}</FieldLabel>
          <Input
            type="text"
            id="object"
            name="object"
            autocomplete="off"
            placeholder={t("contact.form.subjectPlaceholder")}
            required
          />
        </Field>
        <Field>
          <FieldLabel for="phone"
            >{t("contact.form.phone")}
            <span class="text-foreground/50 ml-auto"
              >{t("contact.form.optional")}</span
            >
          </FieldLabel>
          <Input
            type="tel"
            id="phone"
            name="phone"
            autocomplete="tel"
            placeholder={t("contact.form.phonePlaceholder")}
          />
        </Field>
        <Field class="md:col-span-2">
          <FieldLabel for="message">{t("contact.form.message")}</FieldLabel>
          <Textarea
            id="message"
            name="message"
            autocomplete="off"
            placeholder={t("contact.form.messagePlaceholder")}
            class="h-32"
            required
          />
        </Field>
      </FieldSet>
      <Button
        type="submit"
        class="mt-12 ml-auto w-full md:w-auto"
        id="submit-btn"
      >
        {t("contact.form.submit")}
      </Button>
    </form>

    <script>
      const form = document.getElementById(
        "contact-form",
      ) as HTMLFormElement | null;
      const submitBtn = document.getElementById(
        "submit-btn",
      ) as HTMLButtonElement | null;

      if (form) {
        form.addEventListener("submit", () => {
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.setAttribute("aria-busy", "true");
          }
          form.style.opacity = "0.6";
          form.style.pointerEvents = "none";
        });
      }

      if (window.location.search.includes("_action")) {
        const url = new URL(window.location.href);
        if (url.searchParams.has("_action")) {
          url.searchParams.delete("_action");
          window.history.replaceState({}, document.title, url.toString());
        }
      }
    </script>
    <div class="flex grow flex-col gap-16 lg:max-w-96">
      <div class="flex w-full flex-wrap lg:flex-col">
        <div>
          <h2 class="font-barlow text-base font-semibold">
            {t("contact.info.phone")}
          </h2>
          <Button variant="link" class="-mt-3 -ml-6" href="tel:+33475682824">
            +33 4 75 68 28 24
          </Button>
        </div>
        <div>
          <h2 class="font-barlow text-base font-semibold">
            {t("contact.info.whatsapp")}
          </h2>
          <Button
            variant="link"
            class="-mt-3 -ml-6"
            external
            href="https://api.whatsapp.com/send?phone=33475682824"
          >
            +33 4 75 68 28 24
          </Button>
        </div>
        <div>
          <h2 class="font-barlow text-base font-semibold">
            {t("contact.info.email")}
          </h2>
          <Button
            variant="link"
            class="-mt-3 -ml-6"
            external
            href={`mailto:contact@domaine-de-pipangaille.fr`}
          >
            contact@domaine-de-pipangaille.com
          </Button>
        </div>
        <div>
          <h2 class="font-barlow text-base font-semibold">
            {t("contact.info.address")}
          </h2>
          <MapProviderDialog
            lang={lang}
            address={placeAddress}
            triggerVariant="link"
            triggerClass="-mx-6 -my-4 inline-block text-left"
          >
            1 Quartier les Marettes, <br />26140, Andancette, France
          </MapProviderDialog>
        </div>
      </div>
      <div class="self-end">
        <IframeConsent
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2808.7639163355725!2d4.807639176440567!3d45.25256654753427!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47f53e41af912869%3A0xe0c49553166e1500!2sDomaine%20de%20Pipangaille!5e0!3m2!1sen!2sfr!4v1767979480124!5m2!1sen!2sfr"
          serviceName="Google Maps"
        />
      </div>
    </div>
  </section>

  <MediaContent
    title={t("contact.privateRequest.title")}
    text={t("contact.privateRequest.text")}
    image={courtyardConcert}
    direction="left"
    ratio="4-5"
  />
</Layout>

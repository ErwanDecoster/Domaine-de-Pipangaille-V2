---
import Layout from "@/layouts/Layout.astro";
import ActivitiesSection from "@/components/ActivitiesSection.astro";
import RestaurantsSection from "@/components/RestaurantsSection.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import { surroundings } from "@/constants/surroundings";
import { languages } from "@/i18n/ui";
import { Bike } from "@lucide/astro";
import {
  generateLocalizedBreadcrumbList,
  generateLocalizedAttractionsList,
  DEFAULT_ATTRACTIONS,
} from "@/lib/schemaHelpers";

const { lang } = Astro.props as { lang: keyof typeof languages };
const t = useTranslations(lang);

type TranslationKey = Parameters<typeof t>[0];
const toKey = (key: string) => key as TranslationKey;

const ITEMS_PER_PAGE = 6;

const langPrefix = lang === "fr" ? "/" : `/${lang}/`;
const breadcrumbSchema = generateLocalizedBreadcrumbList(
  lang as "fr" | "en" | "de" | "es" | "it" | "nl",
  langPrefix,
  [
    { name: "home", path: "" },
    { name: "surroundings", path: "les-alentours" },
  ],
);

const attractionsSchema = generateLocalizedAttractionsList(
  lang as "fr" | "en" | "de" | "es" | "it" | "nl",
  DEFAULT_ATTRACTIONS,
);

const formatCard = (
  item:
    | (typeof surroundings.toVisit)[number]
    | (typeof surroundings.toEat)[number],
) => {
  const categories = (item as { category?: string[] }).category ?? [];
  const firstImage = item.gallery?.[0];
  const bikeRoute = (item as { bikeRoute?: { tag?: string } }).bikeRoute;

  const allTags: { icon?: any; text: string }[] = [
    ...categories.map((cat) => ({
      text: t(toKey(`surroundings.category.${cat}`)),
    })),
  ];

  if (bikeRoute?.tag) {
    allTags.push({
      icon: Bike,
      text: t(toKey(`surroundings.tags.${bikeRoute.tag}`)),
    } as { icon: any; text: string });
  }

  return {
    key: item.slug,
    title: item.title,
    image: firstImage?.src,
    imageAlt: t(toKey(firstImage?.altKey ?? "")),
    description: item.shortDesc ? t(toKey(item.shortDesc)) : undefined,
    tags: allTags,
    categories,
    buttonText: t("surroundings.card.cta"),
    buttonLink: getLocalizedUrl("surrounding", lang, item.slug),
  };
};

const activities = surroundings.toVisit.map(formatCard);

const restaurantFiltersData = surroundings.toEat.map((item) => {
  const baseCard = formatCard(item);

  return {
    ...baseCard,
    slug: item.slug,
  };
});

const allCategories = [
  ...new Set(surroundings.toVisit.flatMap((item) => item.category ?? [])),
].sort();

const baseRestaurantCategories = [
  ...new Set(surroundings.toEat.flatMap((item) => item.category ?? [])),
].sort();

const restaurantCategories = [
  ...baseRestaurantCategories,
  "openNoon",
  "openEvening",
].sort();

const getTotalPages = (count: number) =>
  Math.max(1, Math.ceil(count / ITEMS_PER_PAGE));
const activitiesTotalPages = getTotalPages(activities.length);
const restaurantsTotalPages = getTotalPages(restaurantFiltersData.length);
---

<Layout
  title={t("seo.pages.surroundings.title")}
  description={t("seo.pages.surroundings.description")}
  ogImage="/og/surroundings/palais_ideal_du_facteur_cheval.jpg"
  additionalSchemas={[breadcrumbSchema, attractionsSchema]}
>
  <div
    data-scroll-animated
    class="bg-background sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
  >
  </div>
  <div class="px-4 pt-12 sm:px-6 md:px-10 md:pt-24 lg:px-20">
    <h1>{t("surroundings.hero.title")}</h1>
    <p class="mt-12 max-w-4xl md:w-4/5">{t("surroundings.hero.text")}</p>
  </div>

  <ActivitiesSection
    lang={lang}
    activities={activities}
    categories={allCategories}
    totalPages={activitiesTotalPages}
  />

  <RestaurantsSection
    lang={lang}
    restaurants={restaurantFiltersData}
    categories={restaurantCategories}
    totalPages={restaurantsTotalPages}
  />
</Layout>

<script>
  import { initializeFilterSystem } from "@/lib/filterSystem";
  import { updateRestaurantOpeningStatus } from "@/lib/businessHoursClient";

  const init = () => {
    const initialize = () => {
      updateRestaurantOpeningStatus();
      initializeFilterSystem();
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initialize);
    } else {
      initialize();
    }
  };

  init();
  document.addEventListener("astro:page-load", init);
</script>

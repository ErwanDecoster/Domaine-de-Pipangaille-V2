---
import Layout from "@/layouts/Layout.astro";
import MediaContent from "@/components/MediaContent.astro";
import PlaceBusinessHours from "@/components/PlaceBusinessHours.astro";
import SurroundingContactInfo from "@/components/SurroundingContactInfo.astro";
import OtherSurroundings from "@/components/OtherSurroundings.astro";
import { reviews } from "@/constants/reviews";
import { surroundings } from "@/constants/surroundings";
import businessHours from "@/constants/businessHours.json";
import { toBusinessHoursKey } from "@/lib/businessHours";
import Header from "../Header.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import NotFoundTemplate from "./NotFoundTemplate.astro";
import { Bike, Mountain, Route } from "@lucide/astro";

const { lang, surroundingName } = Astro.props as {
  lang: keyof typeof reviews;
  surroundingName: string;
};

const t = useTranslations(lang);
const toKey = (key: string) => key as Parameters<typeof t>[0];

const surroundingsInToVisit = surroundings.toVisit.find(
  (surrounding) => surrounding.slug === surroundingName,
);
const surroundingsInToEat = surroundings.toEat.find(
  (surrounding) => surrounding.slug === surroundingName,
);
const surroundingType = surroundingsInToVisit ? "toVisit" : "toEat";

const allSurroundings = surroundings[surroundingType];
const currentIndex = allSurroundings.findIndex(
  (s) => s.slug === surroundingName,
);

const reorderedSurroundings =
  currentIndex !== -1
    ? [
        ...allSurroundings.slice(currentIndex + 1),
        ...allSurroundings.slice(0, currentIndex),
      ]
    : allSurroundings.filter((s) => s.slug !== surroundingName);

const otherSurroundings = reorderedSurroundings;

const isNotFound = !surroundingsInToVisit && !surroundingsInToEat;

const baseSurrounding = !isNotFound
  ? (surroundingsInToVisit ?? surroundingsInToEat!)
  : null;

const selectedSurroundingDescription = baseSurrounding
  ? t(toKey(`surroundings.descriptions.${baseSurrounding.slug}.long`))
  : "";
const selectedSurroundingShortDescription = baseSurrounding
  ? t(toKey(`surroundings.descriptions.${baseSurrounding.slug}.short`))
  : "";
const selectedSurroundingImageAlt = baseSurrounding
  ? t(toKey(baseSurrounding.gallery?.[0]?.altKey ?? ""))
  : "";

const otherSurroundingsTitle =
  surroundingType === "toVisit"
    ? toKey("surroundings.detail.otherActivities.title")
    : toKey("surroundings.detail.otherRestaurants.title");

const surroundingButtonText = t("surroundings.card.cta");
const seeAllButtonText =
  surroundingType === "toVisit"
    ? toKey("surroundings.detail.seeAllActivities")
    : toKey("surroundings.detail.seeAllRestaurants");
const seeAllButtonLink =
  surroundingType === "toEat"
    ? getLocalizedUrl("surroundings", lang) + "#to-eat"
    : getLocalizedUrl("surroundings", lang);

// SEO metadata
const selectedSurroundingOgImage = baseSurrounding
  ? `/og/surroundings/${baseSurrounding.slug}.jpg`
  : "/og/og-image.jpg";

// Get bike route data if available
const bikeRoute = (
  baseSurrounding as {
    bikeRoute?: {
      tag?: string;
      durationMinutes?: number;
      distanceKm?: number;
      elevationGainMeters?: number;
    };
  }
)?.bikeRoute;
const headerTags: { icon?: any; text: string }[] = [];

const formatDurationMinutes = (minutes: number) => {
  if (minutes < 60) {
    return `${minutes}min`;
  }

  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;

  return remainingMinutes
    ? `${hours}h${String(remainingMinutes).padStart(2, "0")}`
    : `${hours}h`;
};

if (bikeRoute?.durationMinutes) {
  headerTags.push({
    icon: Bike,
    text: formatDurationMinutes(bikeRoute.durationMinutes),
  });
}

if (bikeRoute?.elevationGainMeters) {
  headerTags.push({
    icon: Mountain,
    text: `${bikeRoute.elevationGainMeters}m`,
  });
}

if (bikeRoute?.distanceKm) {
  headerTags.push({
    icon: Route,
    text: `${bikeRoute.distanceKm}km`,
  });
}

if (bikeRoute?.tag) {
  headerTags.push({
    icon: Bike,
    text: t(toKey(`surroundings.tags.${bikeRoute.tag}`)),
  });
}

// Check if MediaContent section should be displayed
const businessHoursKey = toBusinessHoursKey(baseSurrounding?.slug ?? "");
const hours =
  businessHours[businessHoursKey as keyof typeof businessHours]?.hours;

const shouldShowMediaContent =
  baseSurrounding?.mapsUrl ||
  baseSurrounding?.socialMedia ||
  (baseSurrounding && "bookLink" in baseSurrounding
    ? baseSurrounding.bookLink
    : undefined) ||
  baseSurrounding?.phoneNumber ||
  hours;
---

{
  isNotFound ? (
    <NotFoundTemplate lang={lang} />
  ) : (
    <Layout
      title={baseSurrounding?.title}
      description={selectedSurroundingShortDescription}
      ogImage={selectedSurroundingOgImage}
    >
      <div
        data-scroll-animated
        class="bg-background sticky top-0 z-10 ml-[calc(50%-50vw)] h-28 w-screen"
      />

      <Header
        title={baseSurrounding?.title ?? ""}
        text={selectedSurroundingDescription}
        image={
          baseSurrounding?.gallery?.[1]?.src ??
          baseSurrounding?.gallery?.[0]?.src
        }
        imageAlt={selectedSurroundingImageAlt}
        buttonText={t("surroundings.detail.visitWebsite")}
        buttonLink={baseSurrounding?.website ?? ""}
        buttonExternal={true}
        buttonVariant="secondary"
        withBackground={false}
        tags={headerTags}
      />

      {shouldShowMediaContent && (
        <MediaContent
          title={t("surroundings.detail.moreInfo.title")}
          text=""
          iframeUrl={baseSurrounding?.mapsUrl ?? ""}
          iframeServiceName="Google Maps"
          direction="left"
          ratio="5-4"
        >
          <div>
            {hours && (
              <PlaceBusinessHours
                lang={lang}
                slug={baseSurrounding?.slug ?? ""}
              />
            )}
          </div>
          <SurroundingContactInfo lang={lang} surrounding={baseSurrounding} />
        </MediaContent>
      )}

      <OtherSurroundings
        lang={lang}
        surroundings={otherSurroundings}
        title={t(otherSurroundingsTitle)}
        buttonText={surroundingButtonText}
        seeAllButtonText={t(seeAllButtonText)}
        seeAllButtonLink={seeAllButtonLink}
      />
    </Layout>
  )
}

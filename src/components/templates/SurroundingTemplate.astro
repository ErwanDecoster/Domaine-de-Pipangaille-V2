---
import Layout from "@/layouts/Layout.astro";
import MediaContent from "@/components/MediaContent.astro";
import { reviews } from "@/constants/reviews";
import { surroundings } from "@/constants/surroundings";
import Card from "../Card.astro";
import Header from "../Header.astro";
import { useTranslations, getLocalizedUrl } from "@/lib/i18n";
import Button from "../ui/button/button.astro";
import PlatformIcon from "../ui/icons/PlatformIcon.astro";
import NotFoundTemplate from "./NotFoundTemplate.astro";
import { Phone } from "@lucide/astro";

const { lang, surroundingName } = Astro.props as {
  lang: keyof typeof reviews;
  surroundingName: string;
};

const t = useTranslations(lang);
const toKey = (key: string) => key as Parameters<typeof t>[0];

const surroundingsInToVisit = surroundings.toVisit.find(
  (surrounding) => surrounding.slug === surroundingName,
);
const surroundingsInToEat = surroundings.toEat.find(
  (surrounding) => surrounding.slug === surroundingName,
);
const surroundingType = surroundingsInToVisit ? "toVisit" : "toEat";
const otherSurroundings = surroundings[surroundingType].filter(
  (s) => s.slug !== surroundingName,
);

const isNotFound = !surroundingsInToVisit && !surroundingsInToEat;

const baseSurrounding = !isNotFound
  ? (surroundingsInToVisit ?? surroundingsInToEat!)
  : null;

const selectedSurroundingDescription = baseSurrounding
  ? t(toKey(`surroundings.descriptions.${baseSurrounding.slug}.long`))
  : "";
const selectedSurroundingImageAlt = baseSurrounding
  ? t(toKey(baseSurrounding.gallery?.[0]?.altKey ?? ""))
  : "";

const otherSurroundingsTitle =
  surroundingType === "toVisit"
    ? toKey("surroundings.detail.otherActivities.title")
    : toKey("surroundings.detail.otherRestaurants.title");

const surroundingButtonText = t("surroundings.card.cta");
const seeAllButtonText =
  surroundingType === "toVisit"
    ? toKey("surroundings.detail.seeAllActivities")
    : toKey("surroundings.detail.seeAllRestaurants");
const seeAllButtonLink =
  surroundingType === "toEat"
    ? getLocalizedUrl("surroundings", lang) + "#to-eat"
    : getLocalizedUrl("surroundings", lang);
---

{
  isNotFound ? (
    <NotFoundTemplate lang={lang} />
  ) : (
    <Layout>
      <div
        data-scroll-animated
        class="bg-background sticky top-0 z-10 h-28 w-screen"
      />

      <Header
        title={baseSurrounding?.title ?? ""}
        text={selectedSurroundingDescription}
        image={
          baseSurrounding?.gallery?.[1]?.src ??
          baseSurrounding?.gallery?.[0]?.src
        }
        imageAlt={selectedSurroundingImageAlt}
        buttonText={t("surroundings.detail.visitWebsite")}
        buttonLink={baseSurrounding?.website ?? ""}
        buttonExternal={true}
        buttonVariant="secondary"
        withBackground={false}
      />

      <MediaContent
        title={t("surroundings.detail.moreInfo.title")}
        text=""
        iframeUrl={baseSurrounding?.mapsUrl ?? ""}
        iframeServiceName="Google Maps"
        direction="left"
      >
        <div class="mt-8 grid gap-8">
          {baseSurrounding?.socialMedia &&
            baseSurrounding?.socialMedia?.length > 0 && (
              <div>
                <h3 class="text-2xl">
                  {t("surroundings.detail.socialNetworks")}
                </h3>
                <ul>
                  <li>
                    {baseSurrounding.socialMedia.map((social) => (
                      <Button
                        class="-ml-4"
                        variant="link"
                        href={social.link}
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        <PlatformIcon
                          platform={social.platform}
                          class="size-4"
                        />
                        {social.platform}
                      </Button>
                    ))}
                  </li>
                </ul>
              </div>
            )}
          <div class="flex gap-6">
            {baseSurrounding?.bookLink ? (
              <Button external href={baseSurrounding.bookLink}>
                {t("surroundings.detail.book")}
              </Button>
            ) : null}
            {baseSurrounding?.phoneNumber ? (
              <Button
                variant="outline"
                href={`tel:${baseSurrounding.phoneNumber}`}
              >
                <Phone />
                {t("surroundings.detail.call")}
              </Button>
            ) : null}
            {baseSurrounding?.website ? (
              <Button
                variant="link"
                class="-mx-6 gap-3!"
                external
                href={baseSurrounding.website}
              >
                {t("surroundings.detail.visitWebsite")}
              </Button>
            ) : null}
          </div>
        </div>
      </MediaContent>

      <section class="mt-48 grid grid-cols-3 gap-8 px-20 md:gap-10">
        <h2 class="col-span-3">{t(otherSurroundingsTitle)}</h2>
        {otherSurroundings.slice(0, 3).map((surrounding) => (
          <Card
            key={surrounding.slug}
            title={surrounding.title}
            image={surrounding.gallery?.[0]?.src}
            imageAlt={t(toKey(surrounding.gallery?.[0]?.altKey ?? ""))}
            description={
              surrounding.shortDesc
                ? t(toKey(surrounding.shortDesc))
                : undefined
            }
            tags={(surrounding as { category?: string[] }).category?.map(
              (cat) => ({
                text: t(toKey(`surroundings.category.${cat}`)),
              }),
            )}
            buttonText={surroundingButtonText}
            buttonLink={getLocalizedUrl("surrounding", lang, surrounding.slug)}
          />
        ))}
        <Button class="col-span-3 mx-auto" href={seeAllButtonLink}>
          {t(seeAllButtonText)}
        </Button>
      </section>
    </Layout>
  )
}

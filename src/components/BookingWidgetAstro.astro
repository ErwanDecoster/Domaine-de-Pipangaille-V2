---
import { Button } from "@/components/ui/button";
import {
  NativeSelect,
  NativeSelectOption,
} from "@/components/ui/native-select";
import RangeCalendarVue from "@/components/RangeCalendarVue.vue";
import { getLocalizedUrl, useTranslations } from "@/lib/i18n";
import { ui } from "@/i18n/ui";
import { X } from "@lucide/astro";

const { lang } = Astro.props as { lang: keyof typeof ui };
const t = useTranslations(lang);
const bookingPath = getLocalizedUrl("booking", lang);
---

<div class="fixed inset-x-0 bottom-0 z-20 pb-4">
  <div
    data-booking-widget
    class="bg-background group/widget relative mx-auto w-fit max-w-5xl rounded-2xl border p-4 shadow-lg has-peer-checked/widget:p-8"
  >
    <div class="flex flex-col items-stretch gap-0 md:items-center">
      <input
        type="checkbox"
        id="booking-widget-toggle"
        class="peer/widget sr-only"
      />

      <label
        for="booking-widget-toggle"
        class="text-muted-foreground hover:text-foreground absolute top-3 right-3 hidden cursor-pointer rounded-sm opacity-70 transition-opacity peer-checked/widget:block hover:opacity-100 md:hidden"
        aria-label={t("home.booking.close")}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="size-6"
          aria-hidden="true"
        >
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </label>

      <label
        for="booking-widget-toggle"
        class="text-primary-foreground bg-primary hover:bg-primary/90 focus-visible:ring-ring inline-flex h-11 w-full cursor-pointer items-center justify-center rounded-md px-8 text-base font-medium whitespace-nowrap transition-colors peer-checked/widget:hidden focus-visible:ring-1 focus-visible:outline-none md:hidden"
      >
        {t("home.booking.button")}
      </label>

      <div
        class="pointer-events-none grid w-full grid-rows-[0fr] opacity-0 transition-[grid-template-rows,opacity] duration-300 ease-in-out peer-checked/widget:pointer-events-auto peer-checked/widget:grid-rows-[1fr] peer-checked/widget:opacity-100 md:pointer-events-auto md:contents md:opacity-100"
      >
        <div class="min-h-0 peer-checked/widget:p-1 md:contents">
          <div
            class="flex min-h-0 flex-col gap-3 md:flex-row md:flex-wrap md:items-center"
          >
            <div class="relative w-full md:w-auto">
              <Button
                variant="outline"
                class="w-full min-w-50 justify-start py-2 text-left font-normal md:w-auto"
                id="date-button"
                aria-haspopup="dialog"
                aria-expanded="false"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="mr-2 size-4"
                  aria-hidden="true"
                >
                  <path d="M8 2v4"></path>
                  <path d="M16 2v4"></path>
                  <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                  <path d="M3 10h18"></path>
                </svg>
                <span id="date-display">{t("home.booking.selectDates")}</span>
              </Button>
            </div>

            <div class="flex w-full items-center gap-2 md:w-auto">
              <label for="adults-select" class="text-sm font-medium">
                {t("home.booking.adults")}
              </label>
              <NativeSelect class="w-20" id="adults-select">
                {
                  Array.from({ length: 9 }, (_, i) => i + 1).map((n) => (
                    <NativeSelectOption value={n.toString()} selected={n === 2}>
                      {n}
                    </NativeSelectOption>
                  ))
                }
              </NativeSelect>
            </div>

            <div class="flex w-full items-center gap-2 md:w-auto">
              <label for="children-select" class="text-sm font-medium">
                {t("home.booking.children")}
              </label>
              <NativeSelect class="w-20" id="children-select">
                {
                  Array.from({ length: 6 }, (_, i) => i).map((n) => (
                    <NativeSelectOption value={n.toString()} selected={n === 0}>
                      {n}
                    </NativeSelectOption>
                  ))
                }
              </NativeSelect>
            </div>

            <Button
              class="w-full md:ml-auto md:w-auto"
              size="lg"
              id="book-button"
              data-booking-path={bookingPath}
            >
              {t("home.booking.button")}
            </Button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    id="calendar-dropdown"
    role="dialog"
    aria-label={t("home.booking.selectDates")}
    aria-hidden="true"
    class="bg-background fixed z-50 hidden rounded-lg border p-4 shadow-lg"
  >
    <div class="mb-4 flex items-center justify-between">
      <h3 class="text-sm font-medium">
        {t("home.booking.selectDates")}
      </h3>
      <Button
        type="button"
        variant="ghost"
        size="icon"
        id="close-dropdown"
        class="absolute top-2 right-2 z-10 touch-manipulation rounded-full hover:bg-white"
        aria-label={t("home.booking.close")}
      >
        <X size={20} />
      </Button>
    </div>
    <RangeCalendarVue client:load lang={lang} />
  </div>
</div>

<script>
  class BookingWidget {
    private widget: HTMLElement;
    private toggle: HTMLInputElement;
    private dateButton: HTMLElement;
    private dropdown: HTMLElement;
    private closeDropdownBtn: HTMLElement;
    private bookButton: HTMLElement;
    private abortController: AbortController;

    constructor(widget: HTMLElement) {
      this.widget = widget;
      this.abortController = new AbortController();

      // Get all required elements
      const toggle = document.getElementById(
        "booking-widget-toggle",
      ) as HTMLInputElement;
      const dateButton = document.getElementById("date-button") as HTMLElement;
      const dropdown = document.getElementById(
        "calendar-dropdown",
      ) as HTMLElement;
      const closeDropdownBtn = document.getElementById(
        "close-dropdown",
      ) as HTMLElement;
      const bookButton = document.getElementById("book-button") as HTMLElement;

      if (
        !toggle ||
        !dateButton ||
        !dropdown ||
        !closeDropdownBtn ||
        !bookButton
      ) {
        throw new Error("Required booking widget elements not found");
      }

      this.toggle = toggle;
      this.dateButton = dateButton;
      this.dropdown = dropdown;
      this.closeDropdownBtn = closeDropdownBtn;
      this.bookButton = bookButton;

      this.init();
    }

    private init(): void {
      const { signal } = this.abortController;

      // Toggle calendar dropdown
      this.dateButton.addEventListener("click", this.handleDateButtonClick, {
        signal,
      });

      // Close dropdown button
      this.closeDropdownBtn.addEventListener("click", this.closeDropdown, {
        signal,
      });

      // Handle booking
      this.bookButton.addEventListener("click", this.handleBooking, { signal });

      // Close on outside click
      document.addEventListener("click", this.handleOutsideClick, { signal });

      // Close on Escape key
      document.addEventListener("keydown", this.handleEscapeKey, { signal });
    }

    private handleDateButtonClick = (e: Event): void => {
      e.stopPropagation();
      e.preventDefault();

      const isOpen = !this.dropdown.classList.contains("hidden");

      if (isOpen) {
        this.closeDropdown();
      } else {
        this.openDropdown();
      }
    };

    private openDropdown = (): void => {
      this.dropdown.classList.remove("hidden");
      this.dateButton.setAttribute("aria-expanded", "true");
      this.dropdown.setAttribute("aria-hidden", "false");
      this.positionDropdown();
    };

    private closeDropdown = (): void => {
      this.dropdown.classList.add("hidden");
      this.dateButton.setAttribute("aria-expanded", "false");
      this.dropdown.setAttribute("aria-hidden", "true");
    };

    private positionDropdown(): void {
      const buttonRect = this.dateButton.getBoundingClientRect();
      this.dropdown.style.left = `${buttonRect.left}px`;
      this.dropdown.style.bottom = `${window.innerHeight - buttonRect.top + 8}px`;
    }

    private handleOutsideClick = (e: Event): void => {
      const target = e.target as Node;

      // Close dropdown if clicking outside
      if (
        !this.dropdown.contains(target) &&
        !this.dateButton.contains(target)
      ) {
        this.closeDropdown();
      }

      // Close widget if clicking outside
      if (!this.widget.contains(target) && !this.dropdown.contains(target)) {
        this.toggle.checked = false;
      }
    };

    private handleEscapeKey = (e: KeyboardEvent): void => {
      if (e.key === "Escape") {
        this.closeDropdown();
        this.toggle.checked = false;
      }
    };

    private handleBooking = (): void => {
      const adultsSelect = document.getElementById(
        "adults-select",
      ) as HTMLSelectElement;
      const childrenSelect = document.getElementById(
        "children-select",
      ) as HTMLSelectElement;

      const adults = adultsSelect?.value || "2";
      const children = childrenSelect?.value || "0";
      const startDate = this.dateButton.dataset.startDate || "";
      const endDate = this.dateButton.dataset.endDate || "";
      const bookingPath = this.bookButton.dataset.bookingPath || "/reservation";

      const bookUrl = new URL(bookingPath, window.location.origin);
      if (startDate) bookUrl.searchParams.set("start_date", startDate);
      if (endDate) bookUrl.searchParams.set("end_date", endDate);
      bookUrl.searchParams.set("adults", adults);
      bookUrl.searchParams.set("children", children);

      window.location.href = bookUrl.toString();
    };

    public destroy(): void {
      this.abortController.abort();
      this.closeDropdown();
    }
  }

  let widgetInstance: BookingWidget | null = null;

  function initBookingWidget(): void {
    // Cleanup previous instance
    widgetInstance?.destroy();

    const widget = document.querySelector<HTMLElement>("[data-booking-widget]");
    if (!widget) {
      console.warn("Booking widget element not found");
      return;
    }

    try {
      widgetInstance = new BookingWidget(widget);
    } catch (error) {
      console.error("Failed to initialize booking widget:", error);
    }
  }

  // Initialize on page load
  document.addEventListener("astro:page-load", initBookingWidget);
</script>

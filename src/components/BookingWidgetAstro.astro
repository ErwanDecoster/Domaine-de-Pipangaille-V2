---
import { Button } from "@/components/ui/button";
import {
  NativeSelect,
  NativeSelectOption,
} from "@/components/ui/native-select";
import RangeCalendarVue from "@/components/RangeCalendarVue.vue";
import { getLocalizedUrl, useTranslations } from "@/lib/i18n";
import { ui } from "@/i18n/ui";

const { lang } = Astro.props as { lang: keyof typeof ui };
const t = useTranslations(lang);
const bookingPath = getLocalizedUrl("booking", lang);
---

<div class="fixed inset-x-0 bottom-0 z-20 pb-4">
  <div
    data-scroll-animated-booking-widget
    class="bg-background group/widget relative mx-auto w-fit max-w-5xl rounded-2xl border p-4 shadow-lg has-peer-checked/widget:p-8"
  >
    <div class="flex flex-col items-stretch gap-0 md:items-center">
      <input
        type="checkbox"
        id="booking-widget-toggle"
        class="peer/widget sr-only"
      />

      <label
        for="booking-widget-toggle"
        class="text-muted-foreground hover:text-foreground absolute top-3 right-3 hidden cursor-pointer rounded-sm opacity-70 transition-opacity peer-checked/widget:block hover:opacity-100 md:hidden"
        aria-label={t("home.booking.close")}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="size-6"
          aria-hidden="true"
        >
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </label>

      <label
        for="booking-widget-toggle"
        class="text-primary-foreground bg-primary hover:bg-primary/90 focus-visible:ring-ring inline-flex h-11 w-full cursor-pointer items-center justify-center rounded-md px-8 text-base font-medium whitespace-nowrap transition-colors peer-checked/widget:hidden focus-visible:ring-1 focus-visible:outline-none md:hidden"
      >
        {t("home.booking.button")}
      </label>

      <div
        class="pointer-events-none grid w-full grid-rows-[0fr] opacity-0 transition-[grid-template-rows,opacity] duration-300 ease-in-out peer-checked/widget:pointer-events-auto peer-checked/widget:grid-rows-[1fr] peer-checked/widget:opacity-100 md:pointer-events-auto md:contents md:opacity-100"
      >
        <div class="min-h-0 peer-checked/widget:p-1 md:contents">
          <div
            class="flex min-h-0 flex-col gap-3 md:flex-row md:flex-wrap md:items-center"
          >
            <div class="relative w-full md:w-auto">
              <Button
                variant="outline"
                class="w-full min-w-50 justify-start py-2 text-left font-normal md:w-auto"
                id="date-button"
                aria-haspopup="dialog"
                aria-expanded="false"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="mr-2 size-4"
                  aria-hidden="true"
                >
                  <path d="M8 2v4"></path>
                  <path d="M16 2v4"></path>
                  <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                  <path d="M3 10h18"></path>
                </svg>
                <span id="date-display">{t("home.booking.selectDates")}</span>
              </Button>
            </div>

            <div class="flex w-full items-center gap-2 md:w-auto">
              <label for="adults-select" class="text-sm font-medium">
                {t("home.booking.adults")}
              </label>
              <NativeSelect class="w-20" id="adults-select">
                {
                  Array.from({ length: 10 }, (_, i) => i + 1).map((n) => (
                    <NativeSelectOption value={n.toString()} selected={n === 2}>
                      {n}
                    </NativeSelectOption>
                  ))
                }
              </NativeSelect>
            </div>

            <div class="flex w-full items-center gap-2 md:w-auto">
              <label for="children-select" class="text-sm font-medium">
                {t("home.booking.children")}
              </label>
              <NativeSelect class="w-20" id="children-select">
                {
                  Array.from({ length: 6 }, (_, i) => i).map((n) => (
                    <NativeSelectOption value={n.toString()} selected={n === 0}>
                      {n}
                    </NativeSelectOption>
                  ))
                }
              </NativeSelect>
            </div>

            <Button
              class="w-full md:ml-auto md:w-auto"
              size="lg"
              id="book-button"
              data-booking-path={bookingPath}
            >
              {t("home.booking.button")}
            </Button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    id="calendar-dropdown"
    role="dialog"
    aria-label={t("home.booking.selectDates")}
    class="bg-background fixed bottom-full left-0 z-50 mb-2 hidden rounded-lg border p-4 shadow-lg"
  >
    <div class="mb-4 flex items-center justify-between">
      <h3 class="text-sm font-medium">
        {t("home.booking.selectDates")}
      </h3>
      <button
        type="button"
        id="close-dropdown"
        class="rounded-sm opacity-70 transition-opacity hover:opacity-100"
        aria-label={t("home.booking.close")}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="size-4"
          aria-hidden="true"
        >
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </button>
    </div>
    <RangeCalendarVue client:idle lang={lang} />
  </div>
</div>

<script>
  const dateButton = document.getElementById("date-button");
  const calendarDropdown = document.getElementById("calendar-dropdown");
  const closeDropdown = document.getElementById("close-dropdown");
  const bookButton = document.getElementById("book-button");

  // Toggle calendar dropdown
  if (dateButton && calendarDropdown) {
    dateButton.addEventListener("click", (e) => {
      e.stopPropagation();
      const isHidden = calendarDropdown.classList.toggle("hidden");
      dateButton.setAttribute("aria-expanded", String(!isHidden));

      // Position the dropdown relative to the button
      if (!isHidden) {
        const buttonRect = dateButton.getBoundingClientRect();
        calendarDropdown.style.left = `${buttonRect.left}px`;
        calendarDropdown.style.bottom = `${window.innerHeight - buttonRect.top + 8}px`;
      }
    });
  }

  // Close calendar dropdown
  if (closeDropdown && calendarDropdown && dateButton) {
    closeDropdown.addEventListener("click", (e) => {
      e.stopPropagation();
      calendarDropdown.classList.add("hidden");
      dateButton.setAttribute("aria-expanded", "false");
    });
  }

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (
      calendarDropdown &&
      dateButton &&
      !calendarDropdown.contains(e.target as Node) &&
      !dateButton.contains(e.target as Node)
    ) {
      calendarDropdown.classList.add("hidden");
      dateButton.setAttribute("aria-expanded", "false");
    }
  });

  // Handle booking
  if (bookButton) {
    bookButton.addEventListener("click", () => {
      const adultsSelect = document.getElementById(
        "adults-select",
      ) as HTMLSelectElement;
      const childrenSelect = document.getElementById(
        "children-select",
      ) as HTMLSelectElement;

      const adults = adultsSelect?.value || "2";
      const children = childrenSelect?.value || "0";

      const startDate = dateButton?.dataset.startDate || "";
      const endDate = dateButton?.dataset.endDate || "";

      const bookingPath = bookButton.dataset.bookingPath || "/reservation";
      const bookUrl = new URL(bookingPath, window.location.origin);

      if (startDate) bookUrl.searchParams.set("start_date", startDate);
      if (endDate) bookUrl.searchParams.set("end_date", endDate);
      bookUrl.searchParams.set("adults", adults);
      bookUrl.searchParams.set("children", children);

      window.location.href = bookUrl.toString();
    });
  }
</script>

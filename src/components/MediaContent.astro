---
import Button from "@/components/ui/button/button.astro";
import { cn } from "@/lib/utils";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import IframeConsent from "@/components/IframeConsent.astro";

interface MediaContentImage {
  src: ImageMetadata;
  alt?: string;
}

interface Props {
  title: string;
  text: string | string[];
  image?: ImageMetadata;
  imageAlt?: string;
  images?: MediaContentImage[];
  iframeUrl?: string;
  iframeServiceName?: string;
  buttonText?: string;
  buttonLink?: string;
  direction?: "left" | "right";
  ratio?: "4-5";
}

const {
  title,
  text,
  image,
  imageAlt,
  images = [],
  iframeUrl,
  iframeServiceName,
  buttonText,
  buttonLink,
  direction,
  ratio,
} = Astro.props as Props;

const gallery = images.length
  ? images
  : image
    ? [{ src: image, alt: imageAlt }]
    : [];

const galleryLayout = !gallery.length
  ? "none"
  : gallery.length === 1
    ? "single"
    : gallery.length === 2
      ? "double"
      : gallery.length === 3
        ? "triple"
        : "multi";

const paragraphs = Array.isArray(text)
  ? text.filter(Boolean)
  : typeof text === "string"
    ? text.split(/\n\s*\n/).filter(Boolean)
    : [];
---

<section
  class={cn(
    "relative grid gap-10 md:gap-20 px-4 sm:px-6 md:px-10 lg:px-20 mt-24 md:mt-48",
    {
      "lg:grid-cols-2": gallery.length > 0 || iframeUrl,
      "lg:grid-cols-1": gallery.length === 0 && !iframeUrl,
      "lg:grid-cols-9": ratio === "4-5",
    },
  )}
>
  {
    gallery.length > 0 && (
      <div
        class={cn("grid gap-4", {
          "lg:order-last": direction === "left",
          "grid-cols-1": galleryLayout === "single",
          "grid-cols-2":
            galleryLayout === "double" || galleryLayout === "triple",
          "grid-cols-3": galleryLayout === "multi",
          "grid-rows-2": galleryLayout === "triple",
          "lg:col-span-4": ratio === "4-5",
        })}
      >
        {gallery.map(({ src, alt }, index) => (
          <Image
            class={cn("w-full rounded-md object-cover", {
              "aspect-video lg:aspect-4/3": galleryLayout !== "triple",
              "h-full": galleryLayout === "triple",
              "row-span-2": galleryLayout === "triple" && index === 0,
              "col-start-2 row-start-1 aspect-video lg:aspect-4/3":
                galleryLayout === "triple" && index === 1,
              "col-start-2 row-start-2 aspect-video lg:aspect-4/3":
                galleryLayout === "triple" && index === 2,
            })}
            quality="40"
            width="624"
            height="470"
            sizes="(min-width: 624px) 624px, 100vw"
            src={src}
            alt={alt ?? `${title} - image ${index + 1}`}
          />
        ))}
      </div>
    )
  }
  {
    iframeUrl && iframeServiceName && (
      <div
        class={cn("grid gap-4", {
          "lg:order-last": direction === "left",
          "col-span-4": ratio === "4-5",
        })}
      >
        <IframeConsent src={iframeUrl} serviceName={iframeServiceName} />
      </div>
    )
  }
  <div
    class={cn("flex flex-col justify-center gap-8", {
      "col-span-2": !gallery.length && !iframeUrl,
      "lg:col-span-5": ratio === "4-5",
    })}
  >
    <h2>{title}</h2>
    {
      paragraphs.length ? (
        <div class="flex flex-col gap-4">
          {paragraphs.map((p) => (
            <p>{p}</p>
          ))}
        </div>
      ) : null
    }
    {
      buttonText && buttonLink && (
        <Button class="self-baseline" href={buttonLink}>
          {buttonText}
        </Button>
      )
    }
    <slot />
  </div>
</section>

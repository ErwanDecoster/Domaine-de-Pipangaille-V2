---
import type { HTMLAttributes } from "astro/types";

import { languages } from "@/i18n/ui";
import { getLocalizedUrl, getRouteKey } from "@/lib/i18n";
import { getCurrentLang } from "@/lib/i18n";
import type { Locale } from "@/i18n/routes";
import { routes } from "@/i18n/routes";
import {
  NativeSelect,
  NativeSelectOption,
} from "@/components/ui/native-select";
import { cn } from "@/lib/utils";

interface Props extends HTMLAttributes<"select"> {
  reduce?: boolean;
}

const { class: className, reduce, ...props } = Astro.props as Props;
const lang = getCurrentLang(Astro.currentLocale);
const currentPath = Astro.url.pathname;
const queryString = Astro.url.search; // Preserve query parameters

/**
 * Generates the translated URL for a given language
 * Detects the current route and translates it to the target language
 * Preserves query parameters
 */
const getLangHref = (targetLocale: Locale) => {
  const cleanPath =
    (
      currentPath
        .replace(/^\/(en|de|es|it|nl)\//, "/")
        .replace(/^\/(en|de|es|it|nl)$/, "/") || "/"
    ).replace(/\/$/, "") || "/";

  let translatedUrl = "";

  if (cleanPath === "/" || cleanPath === "") {
    translatedUrl = targetLocale === "fr" ? "/" : `/${targetLocale}/`;
  } else {
    const routeKey = getRouteKey(cleanPath);

    if (routeKey) {
      translatedUrl = getLocalizedUrl(routeKey, targetLocale);
    } else {
      const segments = cleanPath.split("/").filter(Boolean);

      if (segments.length >= 2) {
        const basePath = "/" + segments[0];
        const slug = segments.slice(1).join("/");

        const dynamicRouteKey = Object.entries(routes).find(
          ([, translations]) => {
            return (
              translations.fr === basePath ||
              Object.values(translations).includes(basePath)
            );
          },
        )?.[0];

        if (
          dynamicRouteKey &&
          (dynamicRouteKey === "accommodation" ||
            dynamicRouteKey === "surrounding")
        ) {
          translatedUrl = getLocalizedUrl(
            dynamicRouteKey as any,
            targetLocale,
            slug,
          );
        } else {
          // Keep current path if route not found, just change language prefix
          translatedUrl =
            targetLocale === "fr" ? cleanPath : `/${targetLocale}${cleanPath}`;
        }
      } else {
        // Keep current path if route not found, just change language prefix
        translatedUrl =
          targetLocale === "fr" ? cleanPath : `/${targetLocale}${cleanPath}`;
      }
    }
  }

  // Append query string if present
  return translatedUrl + queryString;
};
---

<!-- Mobile version: 2 characters -->
<NativeSelect
  id="language-switcher-mobile"
  class={cn(reduce ? "xl:hidden" : "hidden", className)}
  aria-label="Change language"
  {...props}
>
  {
    Object.entries(languages).map(([code]) => (
      <NativeSelectOption
        value={code}
        selected={code === lang}
        data-url={getLangHref(code as Locale)}
        class="capitalize"
      >
        {code.charAt(0).toUpperCase() + code.charAt(1)}
      </NativeSelectOption>
    ))
  }
</NativeSelect>

<!-- Desktop version: full label -->
<NativeSelect
  id="language-switcher-desktop"
  class={cn(reduce ? "hidden xl:block" : "", className)}
  aria-label="Change language"
  {...props}
>
  {
    Object.entries(languages).map(([code, label]) => (
      <NativeSelectOption
        value={code}
        selected={code === lang}
        data-url={getLangHref(code as Locale)}
      >
        {label}
      </NativeSelectOption>
    ))
  }
</NativeSelect>

<script>
  // Handle both mobile and desktop selects
  ["language-switcher-mobile", "language-switcher-desktop"].forEach((id) => {
    const select = document.getElementById(id) as HTMLSelectElement;
    if (select) {
      select.addEventListener("change", (event) => {
        const target = event.target as HTMLSelectElement;
        const selectedOption = target.options[target.selectedIndex];
        const url = selectedOption.getAttribute("data-url");
        if (url) {
          window.location.href = url;
        }
      });
    }
  });
</script>

---
import { Star } from "@lucide/astro";

const { review } = Astro.props;
---

<div
  class="min-w-441px bg-muted group relative grid gap-6 rounded-md p-8"
  onmouseleave="this.querySelector('[data-review-overlay]')?.scrollTo({top:0,behavior:'smooth'})"
>
  <div class="flex gap-1.5">
    <Star />
    <strong>{review.stars}</strong>
  </div>
  <div class="relative h-32 overflow-hidden" data-review-content>
    <p class="line-clamp-5" data-review-preview>
      {review.text}
    </p>
    <div
      data-review-gradient
      class="from-muted pointer-events-none absolute right-0 bottom-0 left-0 h-12 bg-linear-to-t to-transparent opacity-0 transition-opacity group-hover:opacity-0"
    >
    </div>
    <div
      data-review-overlay
      class="bg-muted focus:outline-primary absolute inset-0 overflow-y-auto rounded text-sm opacity-0 transition-opacity group-hover:opacity-100 focus:opacity-100 focus:outline-2 focus:outline-offset-2"
    >
      <p>{review.text}</p>
    </div>
  </div>
  <div class="flex justify-between">
    <span class="capitalize">{review.name}</span>
    <span>{new Date(review.publishedAtDate).toLocaleDateString()}</span>
  </div>
</div>

<script>
  function initReviews() {
    document.querySelectorAll("[data-review-content]").forEach((container) => {
      const preview = container.querySelector(
        "[data-review-preview]",
      ) as HTMLElement;
      const gradient = container.querySelector(
        "[data-review-gradient]",
      ) as HTMLElement;
      const overlay = container.querySelector(
        "[data-review-overlay]",
      ) as HTMLElement;

      if (preview && gradient && overlay) {
        if (preview.scrollHeight > preview.clientHeight) {
          // Content is truncated - show gradient and make overlay accessible
          gradient.style.opacity = "1";
          overlay.setAttribute("tabindex", "0");
          overlay.setAttribute("role", "region");
          overlay.setAttribute("aria-label", "Full review text");
        } else {
          // Content is not truncated - remove accessibility attributes
          overlay.removeAttribute("tabindex");
          overlay.removeAttribute("role");
          overlay.removeAttribute("aria-label");
        }
      }
    });
  }

  initReviews();
  document.addEventListener("astro:page-load", initReviews);
</script>
